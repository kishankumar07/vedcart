<%- include('./layouts/header') %>



<!-- Izitoast CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">

<!-- Izitoast JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>













<style>
  #successMessage {
    color: green;
  }

  #errorMessage {
    color: red;
  }
</style>

<main class="main">
  <div
    class="page-header text-center"
    style="
      background-image: url('/userAssets/home/assets/images/profilePage.webp');
    "
  >
    <div class="container">
      <h1 style="color: azure" class="page-title">My Account</h1>
    </div>
    <!-- End .container -->
  </div>
  <!-- End .page-header -->
  <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
    <div class="container">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
        <li class="breadcrumb-item active" aria-current="page">My Account</li>
      </ol>
    </div>
    <!-- End .container -->
  </nav>
  <!-- End .breadcrumb-nav -->

  <div class="page-content">
    <div class="dashboard">
      <div class="container">
        <div class="row">
          <aside class="col-md-4 col-lg-3">
            <ul
              class="nav nav-dashboard flex-column mb-3 mb-md-0"
              role="tablist"
            >

            <!-- index to all the tabitems -->
              <li class="nav-item">
                <a
                  class="nav-link active"
                  id="tab-dashboard-link"
                  data-toggle="tab"
                  href="#tab-dashboard"
                  role="tab"
                  aria-controls="tab-dashboard"
                  aria-selected="true"
                  >Dashboard</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="tab-orders-link"
                  data-toggle="tab"
                  href="#tab-orders"
                  role="tab"
                  aria-controls="tab-orders"
                  aria-selected="false"
                  >Orders</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="tab-downloads-link"
                  data-toggle="tab"
                  href="#tab-wallet"
                  role="tab"
                  aria-controls="tab-downloads"
                  aria-selected="false"
                  >Wallet</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="tab-address-link"
                  data-toggle="tab"
                  href="#tab-address"
                  role="tab"
                  aria-controls="tab-address"
                  aria-selected="false"
                  >Adresses</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link"
                  id="tab-account-link"
                  data-toggle="tab"
                  href="#tab-password"
                  role="tab"
                  aria-controls="tab-account"
                  aria-selected="false"
                  >Change Password</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/signout">Sign Out</a>
              </li>
            </ul>
          </aside>
          <!-- End .col-lg-3 -->












          <!-- main dashboard page  for viewing the user basic details of the user and editing it-->

          <div class="col-md-8 col-lg-9">
            <div class="tab-content">
              <div
                class="tab-pane fade show active"
                id="tab-dashboard"
                role="tabpanel"
                aria-labelledby="tab-dashboard-link"
              >
                <div class="col-lg-6">
                  <div class="card card-dashboard">
                    <div class="card-body">
                      <h3 class="card-title">Profile Details</h3>
                      <!-- End .card-title -->

                      <p>
                        Name : <%= userNameforProfile.name %><br />

                        Email : <%= userNameforProfile.email %><br />

                        Phone : <%= userNameforProfile.mobile %><br />

                        <% if(!userNameforProfile.googleUser) {%>

                        <a href="/google">Link your google account ?</a><br />

                        <% } %>

                        <!-- <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script><dotlottie-player src="https://lottie.host/e4bfdd69-4e1c-44ec-9dd6-903340c291be/mjMLqsFrvg.json" background="transparent" speed="1" style="width: 150px; height: 100px" direction="1" playMode="normal" loop autoplay></dotlottie-player> -->

                        <a href="#editProfileModal" data-toggle="modal"
                          >Edit <i class="icon-edit"></i
                        ></a>
                      </p>
                    </div>
                    <!-- End .card-body -->
                  </div>
                  <!-- End .card-dashboard -->
                </div>
                <!-- End .col-lg-6 -->












                <!------   modal for editing the user basic details  ------------->
                <div
                  class="modal fade"
                  id="editProfileModal"
                  tabindex="-1"
                  role="dialog"
                  aria-hidden="true"
                >
                  <div
                    class="modal-dialog modal-dialog-centered"
                    role="document"
                  >
                    <div class="modal-content">
                      <div class="modal-body">
                        <button
                          type="button"
                          class="close"
                          data-dismiss="modal"
                          aria-label="Close"
                        >
                          <span aria-hidden="true"
                            ><i class="icon-close"></i
                          ></span>
                        </button>

                        <div class="form-box">
                          <div class="form-tab">
                            <ul class="nav nav-pills nav-fill" role="tablist">
                              <li class="nav-item">
                                <a
                                  class="nav-link active"
                                  id="signin-tab"
                                  data-toggle="tab"
                                  href="#signin"
                                  role="tab"
                                  aria-controls="signin"
                                  aria-selected="true"
                                  >Edit Details</a
                                >
                              </li>
                            </ul>
                            <div class="tab-content" id="tab-content-5">
                              <div
                                class="tab-pane fade show active"
                                id="signin"
                                role="tabpanel"
                                aria-labelledby="signin-tab"
                              >
                                <form
                                  action="/editProfile"
                                  method="post"
                                  onsubmit="return editProfileValidation()"
                                >
                                  <div class="form-group">
                                    <label for="singin-email">Name </label>
                                    <input
                                      type="text"
                                      class="form-control"
                                      id="profileEditName"
                                      name="name"
                                      value="<%= userNameforProfile.name %>"
                                    />
                                    <p
                                      id="nameProfileEditErr"
                                      class="error-message"
                                      style="color: red"
                                    ></p>
                                  </div>
                                  <!-- End .form-group -->

                                  <div class="form-group">
                                    <label for="singin-password">Email </label>
                                    <input
                                      type="email"
                                      class="form-control"
                                      id="email"
                                      name="email"
                                      value="<%= userNameforProfile.email %>"
                                      readonly
                                    />
                                  </div>

                                  <div class="form-group">
                                    <label for="singin-password"
                                      >Mobile Number
                                    </label>
                                    <input
                                      type="text"
                                      class="form-control"
                                      id="profileEditMobile"
                                      name="mobile"
                                      value="<%= userNameforProfile.mobile %>"
                                    />
                                    <p
                                      id="mobileProfileEditErr"
                                      class="error-message"
                                      style="color: red"
                                    ></p>
                                  </div>
                                  <!-- End .form-group -->

                                  <div class="form-footer">
                                    <button
                                      type="submit"
                                      class="btn btn-outline-primary-2"
                                    >
                                      <span>Save changes</span>
                                      <i class="icon-long-arrow-right"></i>
                                    </button>

                                    <!-- End .custom-checkbox -->
                                  </div>
                                  <!-- End .form-footer -->
                                </form>
                              </div>
                              <!-- .End .tab-pane -->
                            </div>
                            <!-- End .tab-content -->
                          </div>
                          <!-- End .form-tab -->
                        </div>
                        <!-- End .form-box -->
                      </div>
                      <!-- End .modal-body -->
                    </div>
                    <!-- End .modal-content -->
                  </div>
                  <!-- End .modal-dialog -->
                </div>
                <!-- End .modal -->
              </div>
              <!-- .End .tab-pane -->


              <!-- modal for editing the user details is over -->




              <!-- this part is for displaying the orders made by the user -->
              <div
                class="tab-pane fade"
                id="tab-orders"
                role="tabpanel"
                aria-labelledby="tab-orders-link"
              >


                <section class="vh-70 gradient-custom-2">
                  <div class="container py-5" id="taborders">


                    <% console.log('orders at userProfile is :',orders) %>

                    <% if(orders?.length!==0) {%>
                    <% orders.forEach(order=> { %>
                    <div class="row align-items-center h-100">
                      <div class="col-md-10 col-lg-8 col-xl-6">
                        <div
                          class="card card-stepper"
                          style="border-radius: 16px"
                        >
                          <div class="card-header p-4">
                            <div
                              class="d-flex justify-content-between align-items-center"
                            >
                              <div>
                                <p class="text-muted mb-2">
                                  Order ID :
                                  <span class="fw-bold text-primary">
                                    <%= order.orderId %>
                                  </span>
                                </p>
                                <p class="text-muted mb-0">
                                  Place On :
                                  <span class="fw-bold text-primary">
                                    <%= moment(order.date).format('DD-MM-YYYY') %>
                                  </span> at:
                                  <span class="fw-bold text-primary">
                                    <%= moment(order.date).format('HH:mm:ss') %>
                                  </span>
                                </p>
                              </div>
                            </div>
                          </div>
                          <div class="card-body p-4">
                            <% order.Products.forEach(product=> { %>
                            <div class="d-flex flex-row mb-4 pb-2 mt-4">
                              <div class="flex-fill">
                                <h5 class="bold">
                                  <a
                                    href="/productPage?id=<%=  product. productId%>"
                                  >
                                    <%= product.name %>
                                  </a>
                                </h5>
                                <p class="text-muted">
                                  Qt: <%= product.quantity %> item
                                </p>
                                <h4 class="mb-3">
                                  ₹ <%= product.subTotal %>
                                  <span class="small text-muted">
                                    <br />
                                    via ( <%=order.paymentMode%>)
                                  </span>
                                </h4>
                              </div>
                              <div>
                                <img
                                  class="align-self-center img-fluid"
                                  src="/adminAssets/imgs/category/<%= product.image[0] %>"
                                  width="150"
                                  height="100"
                                />
                              </div>
                            </div>

<% if(product.orderStatus === 'returned') {%>

<p class="text-warning"><%=product.orderStatus%></p>

<% }else if(product.orderStatus === 'cancelled'){ %>

  <p class="text-danger"><%=product.orderStatus%></p>

  <% }else if(product.orderStatus === 'delivered'){ %>  

    <p class="text-success"><%=product.orderStatus%></p>

<% }else{ %>
  <p class="text-info"><%=product.orderStatus%></p>
  <% }%>


                            <% }); %>



                          </div>

                          
                          <a
                            href="/orderdetails?orderId=<%= order._id %>"
                            class="btn btn-primary"
                            >View More</a
                          >
                        </div>
                      </div>
                    </div>
                    <% }); %>
                    <% }else {%>
                      <td colspan="7">Order details unavailable for this user</td>
                      <% } %>
                  </div>
                </section>
              </div>
              <!-- .End .tab-pane -->





<!-- modal for wallet history view is starting here  -->

<div
class="modal fade"
id="walletHistoryModal"
tabindex="-1"
role="dialog"
aria-hidden="true"
>
<div class="modal-dialog modal-dialog-centered" role="document">
  <div class="modal-content">
    <div class="modal-body">
      <button
        type="button"
        class="close"
        data-dismiss="modal"
        aria-label="Close"
      >
        <span aria-hidden="true"
          ><i class="icon-close"></i
        ></span>
      </button>

      <div class="form-box">
        <div class="form-tab">
          <ul
            class="nav nav-pills nav-fill nav-border-anim"
            role="tablist"
          >
            <li class="nav-item">
              <a
                class="nav-link"
                id="register-tab"
                data-toggle="tab"
                href="#register"
                role="tab"
                aria-controls="register"
                aria-selected="false"
                >Wallet history</a
              >
            </li>
          </ul>
          <div class="tab-content" id="tab-content-5">
            <div class="tab-pane fade show active" id="signin" role="tabpanel" aria-labelledby="signin-tab">
              <div class="table-responsive">
                <table class="table">
                  <thead class="thead-primary">
                                     
                    <tr>
                      <th>Date</th>
                      <th>Amount</th>
                      <th>Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if(userNameforProfile?.wallet_history?.length !==0) {%>
                    <% userNameforProfile?.wallet_history.forEach((wallet)=>{ %>

                    <tr>
                      <td><%=  moment(wallet.date).format('DD-MM-YYYY') %></td>
                      <td>₹<%= wallet.amount %></td>
                      <td><%= wallet.reason %></td>
                    </tr>

                 <% }) %>
                 <% }else{ %>
                  <td colspan="7">Wallet history is empty</td>
                  <% } %>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- .End .tab-pane -->
          </div>
          <!-- End .tab-content -->
        </div>
        <!-- End .form-tab -->
      </div>
      <!-- End .form-box -->
    </div>
    <!-- End .modal-body -->
  </div>
  <!-- End .modal-content -->
</div>
<!-- End .modal-dialog -->
</div>

<!-- wallet history ends here -->





              <div
                class="tab-pane fade"
                id="tab-wallet"
                role="tabpanel"
                aria-labelledby="tab-downloads-link"
              >
                  <div class="col-lg-6">
                  <div class="card card-dashboard">
                    <div class="card-body">
                      <h3 class="card-title">Wallet Information</h3>
                      <!-- End .card-title -->

                      <% if(userNameforProfile?.wallet !== 0) {%>
                      <p>
                        Wallet Balance : ₹<%= userNameforProfile.wallet %>

                       
                        <!-- <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script><dotlottie-player src="https://lottie.host/5154e78e-684f-4826-bc12-d121a055f545/DdWUNPZxpJ.json" background="#FFFFFF" speed="1" style="width: 200px; height: 200px" direction="1" playMode="normal" loop autoplay></dotlottie-player> -->
                        <br>
                        <button
                        type="button"
                        class="btn btn-primary"
                        data-toggle="modal"
                        data-target="#walletHistoryModal"
                      >
                        Wallet history
                      </button>
                      </p>
                      <% }else{ %>
                        <!-- <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script><dotlottie-player src="https://lottie.host/82fa0462-1fe7-4f73-b4e8-b7e7eb0aff75/z8x23pbnQM.json" background="#FFFFFF" speed="1" style="width: 150px; height: 150px" direction="1" playMode="normal" loop autoplay></dotlottie-player> -->
                        Wallet Balance : ₹<%= userNameforProfile.wallet %>
                        <% } %>
                        
                    </div>
                    <!-- End .card-body -->
                  </div>
                  <!-- End .card-dashboard -->
                </div>
              </div>
              <!-- .End .tab-pane -->

              <!-- this is the tab for viewing the address, editing and deleting  the address -->

              <div
                class="tab-pane fade"
                id="tab-address"
                role="tabpanel"
                aria-labelledby="tab-address-link"
              >
                <p>
                  The following addresses will be used on the checkout page by
                  default.
                </p>

                <div class="row">
                  <div class="col-lg-6">
                    <% if(userNameforProfile.addressField &&
                    userNameforProfile.addressField.length > 0 ) { %> <%
                    userNameforProfile.addressField.forEach(address =>{ %>

                    <div class="card card-dashboard">
                      <div class="card-body">
                        <h3 class="card-title">Billing Address</h3>
                        <!-- End .card-title -->

                        <p>
                          <%= address.name %><br />
                          <%= address.mobile %><br />
                          <%= address.addressDetails %><br />
                          <%= address.city %><br />
                          <%= address.state %><br />
                          <%= address.pincode %><br />
                          <a
                            href="#"
                            data-toggle="modal"
                            data-target="#editModal<%=address._id%>"
                            >Edit <i class="icon-edit"></i
                          ></a>

                          <a
                            href="#"
                            style="float: right"
                            onclick="removeAddress('<%=address._id%>')"
                            >Delete <i class="fa-solid fa-trash"></i
                          ></a>
                        </p>
                      </div>
                      <!-- End .card-body -->
                    </div>
                    <% }) %> <% } %>
                    <button
                      type="button"
                      class="btn btn-primary"
                      data-toggle="modal"
                      data-target="#addAddressModal"
                    >
                      Add New Address
                    </button>

                    <!-- End .card-dashboard -->
                  </div>
                  <!-- End .col-lg-6 -->

                  <!-- End .col-lg-6 -->
                </div>
                <!-- End .row -->
              </div>
              <!-- .End .tab-pane -->

              <!-- add address modal that pop up when you click on it-->

              <div
                class="modal fade"
                id="addAddressModal"
                tabindex="-1"
                role="dialog"
                aria-hidden="true"
              >
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-body">
                      <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-label="Close"
                      >
                        <span aria-hidden="true"
                          ><i class="icon-close"></i
                        ></span>
                      </button>

                      <div class="form-box">
                        <div class="form-tab">
                          <ul
                            class="nav nav-pills nav-fill nav-border-anim"
                            role="tablist"
                          >
                            <li class="nav-item">
                              <a
                                class="nav-link"
                                id="register-tab"
                                data-toggle="tab"
                                href="#register"
                                role="tab"
                                aria-controls="register"
                                aria-selected="false"
                                >Add your address here</a
                              >
                            </li>
                          </ul>
                          <div class="tab-content" id="tab-content-5">
                            <div
                              class="tab-pane fade show active"
                              id="signin"
                              role="tabpanel"
                              aria-labelledby="signin-tab"
                            >
                              <form
                                action="/addAddressatProfile"
                                method="post"
                                onsubmit="return addressValidation()"
                              >
                                <div class="form-group">
                                  <label for="singin-email"> Full Name *</label>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="addressAddname"
                                    name="name"
                                  />

                                  <p
                                    id="addressAddnameErr"
                                    class="error-message"
                                    style="color: red"
                                  ></p>
                                </div>
                                <!-- End .form-group -->

                                <div class="row">
                                  <div class="col-sm-6">
                                    <div class="form-group">
                                      <label>Mobile Number *</label>
                                      <input
                                        type="tel"
                                        class="form-control"
                                        id="addressAddmobile"
                                        name="mobile"
                                      />

                                      <p
                                        id="addressAddmobileErr"
                                        class="error-message"
                                        style="color: red"
                                      ></p>
                                    </div>
                                  </div>
                                  <!-- End .form-group -->

                                  <div class="col-sm-6">
                                    <div class="form-group">
                                      <label>Pincode *</label>
                                      <input
                                        type="text"
                                        class="form-control"
                                        id="pincode"
                                        name="pincode"
                                      />

                                      <p
                                        id="pincodeErr"
                                        class="error-message"
                                        style="color: red"
                                      ></p>
                                    </div>
                                    <!-- End .form-group -->
                                  </div>
                                </div>

                                <!-- Address -->
                                <div class="form-group m-5">
                                  <label for="addressDetails">Address</label>
                                  <textarea
                                    class="form-control"
                                    id="addressDetails"
                                    name="addressDetails"
                                    rows="3"
                                  ></textarea>

                                  <p
                                    id="addressErr"
                                    class="error-message"
                                    style="color: red"
                                  ></p>

                                  <!-- <div class="text-danger" id="errorDetails"></div> -->
                                </div>

                                <div class="row">
                                  <div class="col-sm-6">
                                    <div class="form-group">
                                      <label>City *</label>
                                      <input
                                        type="text"
                                        class="form-control"
                                        id="city"
                                        name="city"
                                      />

                                      <p
                                        id="cityErr"
                                        class="error-message"
                                        style="color: red"
                                      ></p>
                                    </div>
                                    <!-- End .form-group -->
                                  </div>
                                  <!-- End .col-sm-6 -->

                                  <div class="col-sm-6">
                                    <div class="form-group">
                                      <label>State *</label>

                                      <select
                                        class="form-control"
                                        id="state"
                                        name="state"
                                      >
                                        <option value="" selected disabled>
                                          Select your state
                                        </option>
                                        <% states.forEach(state => { %>
                                        <option value="<%= state %>">
                                          <%= state %>
                                        </option>
                                        <% }); %>
                                      </select>
                                    </div>
                                    <!-- End .form-group -->
                                  </div>
                                  <!-- End .col-sm-6 -->
                                </div>
                                <!-- End .row -->

                                <div class="form-footer">
                                  <button
                                    type="submit"
                                    class="btn btn-outline-primary-2"
                                  >
                                    <span>Save address</span>
                                    <i class="icon-long-arrow-right"></i>
                                  </button>
                                </div>
                                <!-- End .form-footer -->
                              </form>
                            </div>
                            <!-- .End .tab-pane -->
                          </div>
                          <!-- End .tab-content -->
                        </div>
                        <!-- End .form-tab -->
                      </div>
                      <!-- End .form-box -->
                    </div>
                    <!-- End .modal-body -->
                  </div>
                  <!-- End .modal-content -->
                </div>
                <!-- End .modal-dialog -->
              </div>
              <!-- End .modal -->

              <!-- edit address modal -------------------------------------------------- -->

              <% userNameforProfile.addressField.forEach(address =>{ %>
              <div
                class="modal fade"
                id="editModal<%= address._id %>"
                tabindex="-1"
                role="dialog"
                aria-labelledby="editModalLabel<%= address._id %>"
                aria-hidden="true"
              >
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <!-- Add your modal content here -->
                    <div class="modal-header">
                      <h5
                        class="modal-title"
                        id="editModalLabel<%= address._id %>"
                      >
                        Edit Address
                      </h5>
                      <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-label="Close"
                      >
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>

                    <div class="modal-body">
                      <!-- Add your form fields with predefined values here -->
                      <form id="editForm<%= address._id %>">
                        <!-- Example input field (replace with your actual form fields) -->
                        <div class="modal-body mx-3">
                          <div class="modal-body mx-3">
                            <div class="form-group">
                              <label for="editName<%= address._id %>"
                                >Name</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="editName<%= address._id %>"
                                value="<%= address.name %>"
                                name="name"
                              />

                              <p id="addn" style="color: red"></p>
                            </div>

                            <div class="form-group">
                              <label for="editMobile<%= address._id %>"
                                >Mobile Number</label
                              >
                              <input
                                type="tel"
                                class="form-control"
                                id="editMobile<%= address._id %>"
                                value="<%= address.mobile %>"
                                name="mobile"
                                required
                              />
                              <p id="addm" style="color: red"></p>
                            </div>

                            <div class="form-group">
                              <label for="editPincode<%= address._id %>"
                                >Pincode</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="editPincode<%= address._id %>"
                                value="<%= address.pincode %>"
                                name="pincode"
                                required
                              />
                              <p id="addp" style="color: red"></p>
                            </div>

                            <div class="form-group">
                              <label for="editAddress<%= address._id %>"
                                >Address</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="editAddress<%= address._id %>"
                                value="<%= address.addressDetails %>"
                                name="address"
                                required
                              />
                              <p id="adda" style="color: red"></p>
                            </div>

                            <div class="form-group">
                              <label for="editCity<%= address._id %>"
                                >City</label
                              >
                              <input
                                type="text"
                                class="form-control"
                                id="editCity<%= address._id %>"
                                value="<%= address.city %>"
                                name="city"
                                required
                              />
                              <p id="addc" style="color: red"></p>
                            </div>

                            <div class="form-group">
                              <label for="editState<%= address._id %>"
                                >State</label
                              >

                              <select
                                class="form-control"
                                id="editState<%= address._id %>"
                                name="state"
                              >
                                <option value="" selected disabled>
                                  Select your state
                                </option>
                                <% states.forEach(state => { %>
                                <option value="<%= state %>">
                                  <%= state %>
                                </option>
                                <% }); %>
                              </select>
                            </div>
                            <p id="adds" style="color: red"></p>
                          </div>

                          <!-- Add more fields as needed -->

                          <!-- Example Save button -->
                          <button
                            type="button"
                            class="btn btn-primary"
                            onclick="saveEdit('<%= address._id %>')"
                          >
                            Save Changes
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              <%})%>

              <!-- Password changing area by the user-->

              <div
                class="tab-pane fade"
                id="tab-password"
                role="tabpanel"
                aria-labelledby="tab-account-link"
              >
                <form id="changePasswordForm">
                  <label
                    >Current password (leave blank to leave unchanged)</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    name="currentPassword"
                  />

                  <label>New password (leave blank to leave unchanged)</label>
                  <input type="text" class="form-control" name="newPassword" />

                  <label>Confirm new password</label>
                  <input
                    type="password"
                    class="form-control mb-2"
                    name="confirmNewPassword"
                  />

                  <button
                    type="button"
                    class="btn btn-outline-primary-2"
                    onclick="changePassword()"
                  >
                    <span>SAVE CHANGES</span>
                    <i class="icon-long-arrow-right"></i>
                  </button>
                </form>
                <div id="successMessage"></div>
                <div id="errorMessage"></div>
              </div>
              <!-- .End .tab-pane -->
            </div>
          </div>
          <!-- End .col-lg-9 -->
        </div>
        <!-- End .row -->
      </div>
      <!-- End .container -->
    </div>
    <!-- End .dashboard -->
  </div>
  <!-- End .page-content -->
</main>
<!-- End .main -->

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // ==============  edit the profile valdation===================

  function editProfileValidation() {
    var name = document.getElementById("profileEditName").value.trim();
    var mobile = document.getElementById("profileEditMobile").value.trim();

    // Reset error messages
    document.getElementById("nameProfileEditErr").innerText = "";

    document.getElementById("mobileProfileEditErr").innerText = "";

    var isValid = true;

    // Validate name
    if (name === "") {
      document.getElementById("nameErr").innerText = "Name is required";
      isValid = false;
    } else if (name.length < 2 || !isNaN(name.charAt(0))) {
      document.getElementById("nameErr").innerText =
        "Please enter a valid name";
      isValid = false;
    }
    // else if (!isNaN(name.charAt(0))) { // Check if the first character is a number
    // //     document.getElementById('nameErr').innerText = '';
    // //     isValid = false;
    // // }

    // Validate mobile
    if (mobile === "") {
      document.getElementById("mobileErr").innerText = "Mobile is required";
      isValid = false;
    } else if (!validateMobile(mobile)) {
      document.getElementById("mobileErr").innerText = "Invalid mobile number";
      isValid = false;
    }

    return isValid;
  }

  function validateMobile(mobile) {
    // Simple mobile number validation regex (10 digits)
    var mobileRegex = /^\d{10}$/;
    return mobileRegex.test(mobile);
  }

  //====================for change password by the user===========

  function changePassword() {
    const formData = new FormData(
      document.getElementById("changePasswordForm")
    );

    const formObject = {};
    formData.forEach((value, key) => {
      formObject[key] = value;
    });

    fetch("/changepassword", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formObject),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Network response was not ok");
        }
        return response.json();
      })
      .then((data) => {
        const successMessageDiv = document.getElementById("successMessage");
        const errorMessageDiv = document.getElementById("errorMessage");

        if (data.success) {
          $("#changePasswordForm").load("/userProfile #changePasswordForm");
          // successMessageDiv.textContent = data.message;
          errorMessageDiv.textContent = "";
          document.getElementById("changePasswordForm").reset();

          iziToast.success({
                     title: data.message,            
                     position: 'topRight',
                     theme: 'orange', 
                     color: 'white',
                     backgroundColor: '#79e313'
                        });



        } else {
          errorMessageDiv.textContent = data.message;
          successMessageDiv.textContent = "";
        }
      })
      .catch((error) => {
        console.error(
          "There was a problem changing the password:",
          error.message
        );
      });
  }

  //=---------------address validation------------------------

  function addressValidation() {
    console.log("reacjed jeree");

    var name = document.getElementById("addressAddname").value.trim();
    var mobile = document.getElementById("addressAddmobile").value.trim();
    var pincode = document.getElementById("pincode").value.trim();
    var address = document.getElementById("addressDetails").value.trim();
    var city = document.getElementById("city").value.trim();

    // Reset error messages
    document.getElementById("addressAddnameErr").innerText = "";

    document.getElementById("addressAddmobileErr").innerText = "";
    document.getElementById("pincodeErr").innerText = "";
    document.getElementById("addressErr").innerText = "";
    document.getElementById("cityErr").innerText = "";

    var isValid = true;

    // Validate name
    if (name === "") {
      document.getElementById("addressAddnameErr").innerText =
        "Name is required";
      isValid = false;
    } else if (name.length < 2 || !isNaN(name.charAt(0))) {
      document.getElementById("addressAddnameErr").innerText =
        "Please enter a valid name";
      isValid = false;
    }
    // else if (!isNaN(name.charAt(0))) { // Check if the first character is a number
    // //     document.getElementById('nameErr').innerText = '';
    // //     isValid = false;
    // // }

    // Validate mobile
    if (mobile === "") {
      document.getElementById("addressAddmobileErr").innerText =
        "Mobile is required";
      isValid = false;
    } else if (!validateMobile(mobile)) {
      document.getElementById("addressAddmobileErr").innerText =
        "Invalid mobile number";
      isValid = false;
    }

    // Validate pincode
    if (pincode === "") {
      document.getElementById("pincodeErr").innerText = "Pincode is required";
      isValid = false;
    } else if (!/^\d{6}$/.test(pincode)) {
      // Check for 6 digits
      document.getElementById("pincodeErr").innerText = "Invalid pincode";
      isValid = false;
    }

    //Validate address
    if (address === "") {
      document.getElementById("addressErr").innerText = "Address is required";
      isValid = false;
    }

    // Validate city
    if (city === "") {
      document.getElementById("cityErr").innerText = "City is required";
      isValid = false;
    }

    return isValid;
  }

  function validateMobile(mobile) {
    // Simple mobile number validation regex (10 digits)
    var mobileRegex = /^\d{10}$/;
    return mobileRegex.test(mobile);
  }

  //===============to  edit the address =============================

  function saveEdit(addressId) {
    Swal.fire({
      title: "Are you sure?",
      text: "You are about to update the address.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, update it!",
    }).then((result) => {
      if (result.isConfirmed) {
        const name = document
          .getElementById(`editName${addressId}`)
          .value.trim();
        const mobile = document
          .getElementById(`editMobile${addressId}`)
          .value.trim();
        const pincode = document
          .getElementById(`editPincode${addressId}`)
          .value.trim();
        const address = document
          .getElementById(`editAddress${addressId}`)
          .value.trim();
        const city = document
          .getElementById(`editCity${addressId}`)
          .value.trim();
        const state = document
          .getElementById(`editState${addressId}`)
          .value.trim();

        if (!name || !mobile || !pincode || !address || !city || !state) {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Please fill out all fields",
          });
          return;
        }

        fetch(`/updateaddress/${addressId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name,
            mobile,
            pincode,
            address,
            city,
            state,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Response from the backend:", data);
            if (data.success) {
              // Update the address section with the updated user data
              $("#tabaddress").load("/userProfile #tabaddress");

              Swal.fire({
                icon: "success",
                title: "Success!",
                text: "Address updated successfully.",
              });

              // Close the modal
              $(`#editModal${addressId}`).modal("hide");
            } else {
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Failed to update address. Please try again.",
              });
            }

            window.location.reload();
          })
          .catch((error) => {
            console.error("There was a problem:", error.message);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Failed to update address. Please try again.",
            });
          });
      }
    });
  }

  //remove an address =====================================
  function removeAddress(userId) {
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, delete it!",
    }).then((result) => {
      if (result.isConfirmed) {
        deleteAddress(userId);
      }
    });
  }

  function deleteAddress(userId) {
    fetch(`/removeaddress/${userId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        $("#tabaddress").load("/profile #tabaddress");
        Swal.fire({
          title: "Success!",
          text: "Address removed successfully.",
          icon: "success",
          showCancelButton: false,
          showConfirmButton: false,
          timer: 1500,
        });

        window.location.reload();
      })
      .catch((error) => {
        console.error("Error removing address:", error);
        Swal.fire({
          title: "Error!",
          text: "Failed to remove address.",
          icon: "error",
          showCancelButton: false,
          showConfirmButton: false,
          timer: 1500,
        });
      });
  }
</script>

<%- include('./layouts/footer') %>














