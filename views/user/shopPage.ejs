<%- include('./layouts/header') %>

<style>

.toolbox-left {
    display: flex;
    align-items: center;
}
.toolbox-left input[type="text"] {
    flex: 1; /* Take up remaining space */
    margin-right: 10px; /* Adjust the margin between the input and button */
}


/* Style for search box in it below the banner  */
.toolbox-left {
    display: flex; /* Use flexbox */
    align-items: center; /* Align items vertically */
}

.search-box {
    display: flex; /* Use flexbox */
    align-items: center; /* Align items vertically */
}

.search-box input[type="text"] {
    width: 200px;
    height: 31px;
    margin-right: 10px; /* Add margin between input and button */
}



/* style for not showing two seperate images and instead to show only one and on hover only it should show the other one */
.product-media {
     position: relative;
     overflow: hidden;
 }
 
 .product-link {
     display: block;
 }
 
 .hover-img {
     position: absolute;
     top: 0;
     left: 0;
     opacity: 0;
     transition: opacity 0.3s ease;
 }
 
 .product-link:hover .hover-img {
     opacity: 1;
 }

/* to reduce the height of the banner and make it look more attractive */
 .banner {
    max-height: 250px; /* Adjust the max-height as per your preference */
    overflow: hidden; /* Hide any content that exceeds the max-height */
}
.banner img {
    width: auto;
    height: 100%;
}

</style>

  <body>
    <div class="page-wrapper">
      <main class="main">
        <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
          <div class="container">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="/">Home</a></li>
              <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
              <li class="breadcrumb-item active" aria-current="page">

                <% if (query.category) { %>
                    <%= category.find(cat => cat._id.toString() === query.category).name %>
                <% } else { %>
                    All
                <% } %>

            </li>
            </ol>
          </div>
          <!-- End .container -->
        </nav>
        <!-- End .breadcrumb-nav -->

        <div class="page-content">
          <div class="container">
            <div class="row">
              <div class="col-lg-9 col-xl-4-5col">
                <div 
                  class="category-banners-slider owl-carousel owl-simple owl-nav-inside"
                  data-toggle="owl"
                  data-owl-options='{
                                    "nav": false,
                                    "responsive": {
                                        "768": {
                                            "nav": true
                                        }
                                    }
                                }'
                > <div class="banner banner-poster">
                                    
                  <a href="#">
                      <img src="/uploads/banners/<%= banners %>" alt="Banner">
                  </a>

                  <div hidden class="banner-content banner-content-right">
                      <h3 class="banner-subtitle"><a href="#">Amazing Value</a></h3><!-- End .banner-subtitle -->
                      <h2 class="banner-title"><a href="#">High Performance 4K TVs</a></h2><!-- End .banner-title -->
                      <a href="#" class="banner-link">Shop Now <i class="icon-long-arrow-right"></i></a>
                  </div><!-- End .banner-content -->
              </div><!-- End .banner -->
                 
                  <!-- End .banner -->

                  
                  <!-- End .banner -->
                </div>
                <!-- End .owl-carousel -->

                <div class="mb-3"></div>
                <!-- End .mb-3 -->

              

                <div class="mb-3 mb-lg-5"></div>
                <!-- End .mb-3 mb-lg-5 -->

                <div class="mb-2"></div>
                <!-- End .mb-2 -->

                <div class="mb-4"></div>
                <!-- End .mb-4 -->

                <div class="toolbox">


                  <div class="toolbox-left">
                    <div class="search-box">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search..." aria-label="Search" />
                        <a href="#" onclick="searchProducts()" class="btn btn-link btn-link-dark"><span>Search</span><i class="icon-long-arrow-right"></i></a>
                    </div>
                </div>



                  <div class="toolbox-right">
                    <div class="toolbox-sort">
                        <label for="sortby">Sort by:</label>
                        <div class="select-custom">
                            <select name="sortby" id="sortby" class="form-control" onchange="sortProducts(this)">
                              <option value="select" <% if (!query.sort) { %>selected<% } %>>Select</option>
                              <option value="nameAsc" <% if (query.sort === 'nameAsc') { %>selected<% } %>>A-Z</option>
                                <option value="nameDesc" <% if (query.sort === 'nameDesc') { %>selected<% } %>>Z-A</option>
                                <option value="date" <% if (query.sort === 'date') { %>selected<% } %>>Newly Launched</option>
                            </select>
                        </div>
                    </div>
                    <!-- End .toolbox-sort -->
                </div>
                <!-- End .toolbox-right -->
                
                  <!-- End .toolbox-right -->
                </div>
                <!-- End .toolbox -->


                

                   

                <div class="products mb-3 tablet">
                  <div class="row">
                    <% if(product.length > 0) {%>
                    <% product.forEach(product=>{ %>
                    <div class="col-6 col-md-4 col-xl-3">
                       
                      <div class="product">
                        <figure class="product-media">
                          <span hidden class="product-label label-new">New</span>
                          <a href="/productPage?id=<%= product.id %>" class="product-link">


<!-- this shows two images but the second one only when hover the first image -->
                            <img class="default-img product-image" src="/adminAssets/imgs/category/<%= product.images[0] %>" >
                            <img class="hover-img product-image" src="/adminAssets/imgs/category/<%= product.images[1] %>" >
<!-- the image part hovering ends here -->

                  
                          </a>

                          <div class="product-action-vertical">
                            <% if (user) { %>
                              <a
                                  href="#"
                                  onclick="wishList(event,'<%= product._id %>','<%= user %>')"
                                  class="btn-product-icon btn-wishlist btn-expandable"
                              >
                                  <span>add to wishlist</span>
                              </a>
                          <% } else { %>
                              <a
                                  href="#"
                                  onclick="wishList(event,'<%= product._id %>','')"
                                  class="btn-product-icon btn-wishlist btn-expandable"
                              >
                                  <span>add to wishlist</span>
                              </a>
                          <% } %>



                            <a
                              href="#"
                              class="btn-product-icon btn-compare"
                              title="Compare"
                              ><span>Compare</span></a
                            >
                            <a
                              href="popup/quickView.html"
                              class="btn-product-icon btn-quickview"
                              title="Quick view"
                              ><span>Quick view</span></a
                            >
                          </div>
                          <!-- End .product-action-vertical -->

                          <div class="product-action">
                            <a href="#" 
                            class="btn-product btn-cart"
                            title="Add to cart"
                            onclick="addToCart('<%= user %>','<%= product.id %>');return false;"
                            data-product-id="<%= product.id %>">
                            <span>add to cart</span>
                         </a>
                          </div>
                          <!-- End .product-action -->
                        </figure>
                        <!-- End .product-media -->

                        <div class="product-body">
                          <div class="product-cat">
                            <a href="#"><%= product.category.name %></a>
                          </div>
                          <!-- End .product-cat -->
                          <h3 class="product-title">
                            <a href="product.html"><%= product.name %></a>
                          </h3>
                          <!-- End .product-title -->
                          <div class="product-price">
                            <% if (product.offer || product.category.offer) { %>
                                <div class="row">


                                    <br>
                                    <span class="original-price  " style="margin-left: 10px;text-decoration: line-through;">â‚¹
                                        <%= product.price %>
                                    </span>
                                   
                                    <span class="offer-price" style="color: red;font-size:16px ;">
                                       (<%= product.offer ? product.offer.discount :
                                            product.category.offer.discount %> % Off)
                                    </span> 


                                </div>
                                <span class="w-100" style="color: rgb(0, 170, 0);font-size: 20px;">â‚¹<%= product.offerprice %>
                                        </span>

                                <% } else { %>
                                  <span class="original-price  " style="margin-left: 10px;">â‚¹
                                    <%= product.price %>
                                </span>
                                        <% } %>


                          </div>
                          <!-- End .product-price -->


 <!-- stock part -->
 <% if (product.quantity === 0) { %>
  <h5 style="color: red;">OUT OF STOCK!</h5>
  <% } else if(product.quantity ===3) { %>
      <span style="color: #9f4242;">Only <%=product.quantity%> left!</span>
      <% } else if(product.quantity <=5) { %>
          <span style="color: #ff4545;"> Hurry Only <%=product.quantity%> left!</span>
          <% } %>

        <!-- stock part ends -->






                          <div  class="ratings-container">
                            <div class="ratings">
                              <div class="ratings-val" style="width: 80%"></div>
                              <!-- End .ratings-val -->
                            </div>
                            <!-- End .ratings -->
                            <span class="ratings-text">( 12 Reviews )</span>
                          </div>
                          <!-- End .rating-container -->
                        </div>
                        <!-- End .product-body -->
                      </div>
                     
                      <!-- End .product -->
                    </div>


                    <%  }) %>
                    <% } else { %>
                      <tr>
                        <td colspan="2">Product not found</td>
                      </tr>
                      <% } %>




                    <!-- End .col-sm-6 col-md-4 col-xl-3 -->

                  
                    <!-- End .col-sm-6 col-md-4 col-xl-3 -->

                     
                    <!-- End .col-sm-6 col-md-4 col-xl-3 -->

                   
                    <!-- End .col-sm-6 col-md-4 col-xl-3 -->

                  
                    <!-- End .col-sm-6 col-md-4 col-xl-3 -->

                  
                    <!-- End .col-sm-6 col-md-4 col-xl-3 -->

                    <!-- End .col-sm-6 col-md-4 col-xl-3 -->
                  </div>
                  <!-- End .row -->
                </div>
                <!-- End .products -->
                
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <% if (pagination.currentPage > 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>" aria-label="Previous">
                                <span aria-hidden="true"><i class="icon-long-arrow-left"></i></span>Prev
                              </a>
                        </li>
                      <% } %>
                      <% for (let i = 1; i <= pagination.totalPages; i++) { %>
                        <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                            <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                          </li>
                      <% } %>
                      <% if (pagination.currentPage < pagination.totalPages) { %>
                        <li class="page-item">
                          <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>"
                            aria-label="Next">
                            Next<span aria-hidden="true"><i class="icon-long-arrow-right"></i></span>
                          </a>
                        </li>
                      <% } %>
                    </ul>
                  </nav>
                  
              </div>
              <!-- End .col-lg-9 -->

              <aside class="col-lg-3 col-xl-5col order-lg-first">
                <div class="sidebar sidebar-shop">
                  <div class="widget widget-categories">
                    <h3 class="widget-title">Category</h3>
                    <!-- End .widget-title -->
                    <div class="widget-body">
                      <div class="filter-items">
                        <div class="filter-item">

                            <% category.forEach((category,index)=>{ %>
                               
                          <div class="custom-control custom-radio">
                            <input
                              type="radio"
                              class="custom-control-input"
                              id="category-<%= index + 1 %>"
                              name="filter-category"
                              onclick="filterByCategory('<%= category._id.toString() %>')"   <% if (query.category === category._id.toString()) { %>checked<% } %>
                              
                            />
                            <label class="custom-control-label" for="category-<%= index + 1 %>"><%= category.name %></label>
                          </div>

                          <% }) %>

                          <!-- End .custom-checkbox -->
                         
                        </div>
                        <!-- End .filter-item -->

                       <br>
                        <!-- End .filter-item -->

                       
                        <!-- End .filter-item -->
                      </div>
                      <!-- End .filter-items -->
                    </div>
                    
                    <!-- End .widget-body -->
                  </div>
                  <!-- End .widget -->

                  
                  <!-- End .widget -->

                  <div class="widget">
                    <h3 class="widget-title">Price</h3>
                    <!-- End .widget-title -->

                    <div class="widget-body">
                      <div class="filter-items">
                        <div class="filter-item">
                          <div class="custom-control custom-radio">
                            <input
                              type="radio"
                              class="custom-control-input"
                              id="price-low-to-high"
                              name="filter-price"
                              onclick="filterByPrice('low-to-high')"
                              <% if (query.price === 'low-to-high') { %>checked<% } %>
                            />
                            <label class="custom-control-label" for="price-low-to-high"
                            > low to high</label
                            >
                          </div>
                          <!-- End .custom-checkbox -->
                          <div class="custom-control custom-radio">
                            <input
                              type="radio"
                              class="custom-control-input"
                              id="price-high-to-low"
                              name="filter-price"
                              onclick="filterByPrice('high-to-low')"
                              <% if (query.price === 'high-to-low') { %>checked<% } %>
                            />
                            <label class="custom-control-label" for="price-high-to-low"
                            > High to low</label
                            >
                          </div>
                        </div>
                        <!-- End .filter-item -->

                       
                        <!-- End .filter-item -->

                       
                        <!-- End .filter-item -->
                      </div>
                      <!-- End .filter-items -->
                    </div>
                    <!-- End .widget-body -->
                  </div>
                  <!-- End .widget -->

                 
                  <!-- End .widget -->

                
                </div>
                <!-- End .sidebar sidebar-shop -->
              </aside>
              <!-- End .col-lg-3 -->
            </div>
            <!-- End .row -->
          </div>
          <!-- End .container -->
        </div>
        <!-- End .page-content -->

        <div class="cta cta-horizontal cta-horizontal-box bg-primary">
          <div class="container">
            <div class="row align-items-center">
              <div class="col-lg-5">
                <h3 class="cta-title text-white">Join Our Newsletter</h3>
                <!-- End .cta-title -->
                <p class="cta-desc text-white">
                  Subcribe to get information about products and coupons
                </p>
                <!-- End .cta-desc -->
              </div>
              <!-- End .col-lg-5 -->

              <div class="col-lg-7">
                <form action="#">
                  <div class="input-group">
                    <input
                      type="email"
                      class="form-control form-control-white"
                      placeholder="Enter your Email Address"
                      aria-label="Email Adress"
                      required
                    />
                    <div class="input-group-append">
                      <button class="btn btn-outline-white-2" type="submit">
                        <span>Subscribe</span
                        ><i class="icon-long-arrow-right"></i>
                      </button>
                    </div>
                    <!-- .End .input-group-append -->
                  </div>
                  <!-- .End .input-group -->
                </form>
              </div>
              <!-- End .col-lg-7 -->
            </div>
            <!-- End .row -->
          </div>
          <!-- End .container -->
        </div>
        <!-- End .cta -->
      </main>
      <!-- End .main -->



      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script>
     
        // Function to handle sorting products
function sortProducts(input) {
  const sortValue = input.value;

console.log('this is the sortValue ::::',sortValue)

  const searchParams = new URLSearchParams(window.location.search);

  console.log('searchParams at sortValue is :',searchParams)

  searchParams.set('sort', sortValue);


  // setTimeout(() => {
  window.location.href = `/shop?${searchParams.toString()}`;
// }, 60000);
}






// Function to handle selecting a category for filtering
function filterByCategory(categoryId) {
  const searchParams = new URLSearchParams(window.location.search);

console.log('searchParams at filterByCategory is :',searchParams)

  searchParams.set('category', categoryId);
  // Remove other filtering options when changing the category

  // setTimeout(() => {
  window.location.href = `/shop?${searchParams.toString()}`;
// }, 60000000);
}






// Function to handle filtering products by price range
function filterByPrice(priceRange) {
  const searchParams = new URLSearchParams(window.location.search);

console.log('searchParams at filterbyprice is :',searchParams)

  searchParams.set('price', priceRange);
  // Remove other filtering options when changing the price range
  // setTimeout(() => {
  window.location.href = `/shop?${searchParams.toString()}`;
// }, 60000);
}







// Function to handle searching for products
function searchProducts() {
    const searchInput = document.getElementById('searchInput').value;

console.log('searchinput at searchProudct :',searchInput)

    const searchParams = new URLSearchParams(window.location.search);

console.log('searchParams is :',searchParams)

    searchParams.set('search', searchInput);

    // Delay the redirection using setTimeout
    // setTimeout(() => {
        window.location.href = `/shop?${searchParams.toString()}`;
    // }, 60000); // Delay for 10 seconds (10000 milliseconds)
}







    window.addEventListener('DOMContentLoaded', (event) => {
        const urlParams = new URLSearchParams(window.location.search);
        const searchInput = document.getElementById('searchInput');
        const searchQuery = urlParams.get('search');

        if (searchQuery) {
            searchInput.value = searchQuery;
        }
        searchInput.addEventListener('input', function() {
            if (this.value.trim() === '') {
                clearSearchFilter();
            }
        });
    });
    function clearSearchFilter() {
        const searchParams = new URLSearchParams(window.location.search);
        searchParams.delete('search');
        window.location.href = `/shop?${searchParams.toString()}`;
    }






//===========wishlisting a product==============================

function wishList(event,productId,userId){
    event.preventDefault();
  // console.log('this is the user id at wishlist addition :',typeof userId);
  // console.log('this is the product id at wishlist add : ',productId);

  //case if the usr is not logged in
  if(!userId ||userId === String(null) ){
    Swal.fire({
        title: 'Login to Purchase',
        text: 'To make a purchase, please log in.',
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Login'
    }).then((result) => {
        if (result.isConfirmed) {
            
            window.location.href = '/signin';
        }
    });
  }

else{
  //if the user is already logged-----------
  fetch(`/productaddtowishlist?productId=${productId}&userId=${userId}`, {
            method: 'POST', // Use POST or PATCH for updating data
            headers: {
            'Content-Type': 'application/json',
             },
        
    }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
           
            return response.json();
        })
        .then(data => {
            
            if(data.success===true)
            {
              
              Swal.fire({
          title: "Added to Wishlist",
          // text: "OTP Successfully sent to <%= locals.email%>",
          icon: "success",
          timer: 2500,
          showConfirmButton: false, // This removes the button
        });
            
            }
        
            else{
              Swal.fire({
          title: "Already added to wishlist",
          // text: "OTP Successfully sent to <%= locals.email%>",
          icon: "warning",
          timer: 2500,
          showConfirmButton: false, // This removes the button
        });

              
            }})
                   
           
        
        
        .catch(error => {
            console.error('Error:', error);
        });

}

}



// ---------------  adding a product to cart -----------------------------
function addToCart(userId,productId) {

// let quantity = document.getElementById('qty').value;
// console.log('this is the quantity ::',quantity);



if(!userId || userId === 'null'){
Swal.fire({
title: 'Login to Purchase',
text: 'To make a purchase, please log in.',
icon: 'info',
showCancelButton: true,
confirmButtonColor: '#3085d6',
cancelButtonColor: '#d33',
confirmButtonText: 'Login'
}).then((result) => {
if (result.isConfirmed) {
  
  window.location.href = '/signin';
}
});
}
// else if(quantity === '0'){
//  console.log('else if is only working');
//   addToCartButton.disabled = true;


// }
else{
let quantity = 1;

              fetch(`/addTocart/${productId}/${quantity}/${userId}`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      quantity: quantity,
                  }),
              })
              .then((response) => {
                  if (response.status === 401) {
                      throw new Error('User not authenticated. Please login first.');
                  }
                  return response.json();
              })
              
              .then((data) => {
                  console.log('Response from the backend while product added to cart:', data);
      
                  Swal.fire({
                      icon: 'success',
                      title: 'Product added to cart!',
                      showConfirmButton: false,
                      timer: 500, 

                  })})
                 

              .catch((error) => {
                  console.error('Error at product addition to the cart :', error);
                  Swal.fire({
                      icon: 'error',
                      title: 'Error adding to cart',
                      text: error.message || 'An error occurred while adding the product to the cart.',
                  });
              });
       }

}









      </script>


      <%- include('./layouts/footer') %>


























      