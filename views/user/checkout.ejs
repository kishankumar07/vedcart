<%- include('./layouts/header') %>




<!-- Izitoast CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css">

<!-- Izitoast JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>






 <!-- Sign in / Register Modal -->
 <div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"><i class="icon-close"></i></span>
                </button>

                <div class="form-box">
                    <div class="form-tab">
                        <ul class="nav nav-pills nav-fill nav-border-anim" role="tablist">
                           
                            <li class="nav-item">
                                <a class="nav-link" id="register-tab" data-toggle="tab" href="#register" role="tab" aria-controls="register" aria-selected="false">Add your address here</a>
                            </li>
                        </ul>
                        <div class="tab-content" id="tab-content-5">
                            <div class="tab-pane fade show active" id="signin" role="tabpanel" aria-labelledby="signin-tab">
                                <form action="/addAddress" method="post" onsubmit="return addressValidation()">


                                    <div class="form-group">
                                        <label for="singin-email"> Full Name *</label>
                                        <input type="text" class="form-control" id="name" name="name" required>

										<p id="nameErr" class="error-message" style="color: red;"></p>

                                    </div><!-- End .form-group -->



									<div class="row">
										<div class="col-sm-6">
										<div class="form-group">
											<label>Mobile Number *</label>
											<input type="tel" class="form-control" id="mobile" name="mobile" required>

											<p id="mobileErr" class="error-message" style="color: red;"></p>

										</div>
										</div><!-- End .form-group -->

										<div class="col-sm-6">
										<div class="form-group">
											<label>Pincode *</label>
											<input type="text" class="form-control" id="pincode" name="pincode" required>

											<p id="pincodeErr" class="error-message" style="color: red;"></p>

										</div><!-- End .form-group -->
									</div>
									</div>



									 <!-- Address -->
    <div class="form-group m-5">
        <label for="addressDetails">Address</label>
        <textarea class="form-control" id="addressDetails" name="addressDetails" rows="3" required></textarea>

		<p id="addressErr" class="error-message" style="color: red;"></p>

        <!-- <div class="text-danger" id="errorDetails"></div> -->
    </div>




	<div class="row">
		<div class="col-sm-6">
			<div class="form-group">
				<label>City *</label>
				<input type="text" class="form-control" id="city" name="city" required>

				<p id="cityErr" class="error-message" style="color: red;"></p>

			</div><!-- End .form-group -->
		</div><!-- End .col-sm-6 -->

		<div class="col-sm-6">
			<div class="form-group">
				<label>State *</label>


				
					<select class="form-control" id="state" name="state" required>
						<option value="" selected disabled>Select your state</option>
						<% states.forEach(state => { %>
							<option value="<%= state %>"><%= state %></option>
						<% }); %>
					</select>
				
				
			</div><!-- End .form-group -->
		</div><!-- End .col-sm-6 -->
	</div><!-- End .row -->

                                    <div class="form-footer">
                                        <button type="submit" class="btn btn-outline-primary-2">
                                            <span>Save address</span>
                                            <i class="icon-long-arrow-right"></i>
                                        </button>

                                                                       
                                    </div><!-- End .form-footer -->
                                </form>
                             
                            </div><!-- .End .tab-pane -->

             
                        </div><!-- End .tab-content -->
                    </div><!-- End .form-tab -->
                </div><!-- End .form-box -->
            </div><!-- End .modal-body -->
        </div><!-- End .modal-content -->
    </div><!-- End .modal-dialog -->
</div><!-- End .modal -->





        <main class="main">
        	<div class="page-header text-center" style="background-image: url('/userAssets/home/assets/images/checkoutPage.jpg')">
        		<div class="container">
        			<h1 style="color: white
                    ;" class="page-title">Checkout<span>Shop</span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->



              
              
            <div class="page-content">
            	<div class="checkout">
	                <div class="container">
            			<div class="checkout-discount">
            				
            			</div><!-- End .checkout-discount -->
            			<form action="#">
		                	<div class="row">
		                		<div class="col-lg-9">
		                			<h2 class="checkout-title">Billing Details</h2><!-- End .checkout-title -->

									<select id="existingAddresses" name="existingAddress" class="form-control">
										<option value="" selected>Select an address</option>
										<% if (userNameforProfile.addressField.length > 0) { %>
											<% userNameforProfile.addressField.forEach(address => { %>
												<option value="<%= JSON.stringify(address) %>">
													<%= `Name: ${address.name}, Mobile: ${address.mobile}, Address: ${address.addressDetails}, City: ${address.city}, State: ${address.state}` %>
												</option>
											<% }) %>
										<% } %>
									</select>
									
									
									
									

									<hr>


									<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addAddressModal">
										Add New Address
									</button>


<br><br>


<!-- Add this code below the address field -->
<div class="col-lg-9">
    <!-- Other content -->

    <!-- Table to display ordered products -->
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
            </tr>
        </thead>
        <tbody>
            <% cartData.products.forEach(product => { %>
                <tr>
                    <td><%= product.name %></td>
                    <td>₹ <%= product.totalPrice %>.00</td>
                </tr>
            <% }); %>
        </tbody>
    </table>
</div><!-- End .col-lg-9 -->







	            					
		                		</div><!-- End .col-lg-9 -->
		                		<aside class="col-lg-3">
		                			<div class="summary">
		                				<h3 class="summary-title">Your Order</h3><!-- End .summary-title -->

		                				<table class="table table-summary">
		                					<thead>
		                						<tr>
		                							<th>Product</th>
		                							<th>Total</th>
		                						</tr>
		                					</thead>

		                					<tbody>

												<% cartData.products.forEach(cartData => { %>
											
		                						<tr>
		                							<td><a href="#"><%= cartData.name %></a></td>
		                							<td>₹ <%= cartData.totalPrice %>.00</td>
		                						</tr>
										<%	}) %>
		                						
		                						<tr class="summary-subtotal">
		                							<td>Total:</td>
		                							<td>₹ <%= locals.totalOfSubTotals %>.00</td>
		                						</tr><!-- End .summary-subtotal -->
		                						<tr>
		                							<td>Shipping:</td>
		                							<td><%= locals.shippingCharges %></td>
		                						</tr>
		                						<tr class="summary-total">
		                							<td>Grand Total:</td>
		                							<td><%= locals.grandTotal %>.00</td>
		                						</tr><!-- End .summary-total -->
		                					</tbody>
		                				</table><!-- End .table table-summary -->



										
		                				<div class="accordion-summary" id="accordion-payment">
											<div class="payment-method-dropdown">
												<select name="paymentMethod" id="payment" class="payment-method-select">
													<option value="Cash on delivery">Cash on delivery</option>
													<option value="Razorpay">Razorpay</option>
													<option value="wallet">Wallet</option>
												</select>
											</div>
										</div>
										

		                				<button onclick="sendSelection();return false" type="submit" class="btn btn-outline-primary-2 btn-order btn-block">
		                					<span class="btn-text">Place Order</span>

		                					<span class="btn-hover-text">Proceed to Checkout</span>
		                				</button>
		                			</div><!-- End .summary -->
		                		</aside><!-- End .col-lg-3 -->
		                	</div><!-- End .row -->
            			</form>
	                </div><!-- End .container -->
                </div><!-- End .checkout -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->

        <footer class="footer">
        	<div class="footer-middle">
	            <div class="container">
	            	<div class="row">
	            		<div class="col-sm-6 col-lg-3">
	            			<div class="widget widget-about">
	            				<img src="/userAssets/home/assets/images/logo.png" class="footer-logo" alt="Footer Logo" width="105" height="25">
	            				<p>Praesent dapibus, neque id cursus ucibus, tortor neque egestas augue, eu vulputate magna eros eu erat. </p>

	            				<div class="social-icons">
	            					<a href="#" class="social-icon" target="_blank" title="Facebook"><i class="icon-facebook-f"></i></a>
	            					<a href="#" class="social-icon" target="_blank" title="Twitter"><i class="icon-twitter"></i></a>
	            					<a href="#" class="social-icon" target="_blank" title="Instagram"><i class="icon-instagram"></i></a>
	            					<a href="#" class="social-icon" target="_blank" title="Youtube"><i class="icon-youtube"></i></a>
	            					<a href="#" class="social-icon" target="_blank" title="Pinterest"><i class="icon-pinterest"></i></a>
	            				</div><!-- End .soial-icons -->
	            			</div><!-- End .widget about-widget -->
	            		</div><!-- End .col-sm-6 col-lg-3 -->

	            		<div class="col-sm-6 col-lg-3">
	            			<div class="widget">
	            				<h4 class="widget-title">Useful Links</h4><!-- End .widget-title -->

	            				<ul class="widget-list">
	            					<li><a href="about.html">About Molla</a></li>
	            					<li><a href="#">How to shop on Molla</a></li>
	            					<li><a href="#">FAQ</a></li>
	            					<li><a href="contact.html">Contact us</a></li>
	            					<li><a href="login.html">Log in</a></li>
	            				</ul><!-- End .widget-list -->
	            			</div><!-- End .widget -->
	            		</div><!-- End .col-sm-6 col-lg-3 -->

	            		<div class="col-sm-6 col-lg-3">
	            			<div class="widget">
	            				<h4 class="widget-title">Customer Service</h4><!-- End .widget-title -->

	            				<ul class="widget-list">
	            					<li><a href="#">Payment Methods</a></li>
	            					<li><a href="#">Money-back guarantee!</a></li>
	            					<li><a href="#">Returns</a></li>
	            					<li><a href="#">Shipping</a></li>
	            					<li><a href="#">Terms and conditions</a></li>
	            					<li><a href="#">Privacy Policy</a></li>
	            				</ul><!-- End .widget-list -->
	            			</div><!-- End .widget -->
	            		</div><!-- End .col-sm-6 col-lg-3 -->

	            		<div class="col-sm-6 col-lg-3">
	            			<div class="widget">
	            				<h4 class="widget-title">My Account</h4><!-- End .widget-title -->

	            				<ul class="widget-list">
	            					<li><a href="#">Sign In</a></li>
	            					<li><a href="cart.html">View Cart</a></li>
	            					<li><a href="#">My Wishlist</a></li>
	            					<li><a href="#">Track My Order</a></li>
	            					<li><a href="#">Help</a></li>
	            				</ul><!-- End .widget-list -->
	            			</div><!-- End .widget -->
	            		</div><!-- End .col-sm-6 col-lg-3 -->
	            	</div><!-- End .row -->
	            </div><!-- End .container -->
	        </div><!-- End .footer-middle -->

	        <div class="footer-bottom">
	        	<div class="container">
	        		<p class="footer-copyright">Copyright © 2019 Molla Store. All Rights Reserved.</p><!-- End .footer-copyright -->
	        		<figure class="footer-payments">
	        			<img src="userAssets/home/assets/images/payments.png" alt="Payment methods" width="272" height="20">
	        		</figure><!-- End .footer-payments -->
	        	</div><!-- End .container -->
	        </div><!-- End .footer-bottom -->
        </footer><!-- End .footer -->
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>



	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function addressValidation() {
    var name = document.getElementById('name').value.trim();
    var mobile = document.getElementById('mobile').value.trim();
    var pincode = document.getElementById('pincode').value.trim();
    var address = document.getElementById('addressDetails').value.trim();
    var city = document.getElementById('city').value.trim();


    // Reset error messages
    document.getElementById('nameErr').innerText = '';
   
    document.getElementById('mobileErr').innerText = '';
    document.getElementById('pincodeErr').innerText = '';
    document.getElementById('addressErr').innerText = '';
    document.getElementById('cityErr').innerText = '';

    var isValid = true;

     // Validate name
	 if (name === '') {
        document.getElementById('nameErr').innerText = 'Name is required';
        isValid = false;
    } else if (name.length < 2 || !isNaN(name.charAt(0)) ) {
        document.getElementById('nameErr').innerText = 'Please enter a valid name';
        isValid = false;
    } 
	// else if (!isNaN(name.charAt(0))) { // Check if the first character is a number
    // //     document.getElementById('nameErr').innerText = '';
    // //     isValid = false;
    // // }

  
    // Validate mobile
    if (mobile === '') {
        document.getElementById('mobileErr').innerText = 'Mobile is required';
        isValid = false;
    } else if (!validateMobile(mobile)) {
        document.getElementById('mobileErr').innerText = 'Invalid mobile number';
        isValid = false;
    }

   
     // Validate pincode
	 if (pincode === '') {
        document.getElementById('pincodeErr').innerText = 'Pincode is required';
        isValid = false;
    } else if (!/^\d{6}$/.test(pincode)) { // Check for 6 digits
        document.getElementById('pincodeErr').innerText = 'Invalid pincode';
        isValid = false;
    }


	//Validate address
  if (address === '') {
    document.getElementById('addressErr').innerText = 'Address is required';
    isValid = false;
}

// Validate city
if (city === '') {
  document.getElementById('cityErr').innerText = 'City is required';
  isValid = false;
}

    return isValid;
}

function validateMobile(mobile) {
    // Simple mobile number validation regex (10 digits)
    var mobileRegex = /^\d{10}$/;
    return mobileRegex.test(mobile);
}


//For getting the address from the input field of the address
let selectedAddress;
const dropdown = document.getElementById('existingAddresses');

dropdown.addEventListener('change', function() {
     selectedAddress = this.value;
    //   console.log('this is the selected address :',selectedAddress);

})

function sendSelection(){


	const paymentMethod = document.getElementById("payment").value;
// console.log('selected address is :',selectedAddress);


if (selectedAddress === '' || selectedAddress === undefined) {
                   // Show Izitoast toast with warning message
iziToast.warning({
    title: 'Please select an address',
    // message: 'You must select an address before proceeding.',
    position: 'topRight',
    timeout: 2500 // Adjust the duration as needed
});

                    return;
                }

				const selectedValue = JSON.parse(selectedAddress);
console.log('after parsiing : : ',selectedValue);


fetch('/placeorder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({

                        paymentMethod: paymentMethod,
                        selectedValue: selectedValue,
                       

                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Backend response after order placed:', data);


                        if (data.success) {
                            Swal.fire({
                                title: 'Order Placed Successfully!',
                                icon: 'success',
                                showConfirmButton: false,
                                timer: 2000

                            });

                            setTimeout(() => {

                                window.location.href = '/ordersuccess';
                            }, 2000)
                        } else if (data.message) {
                            // Display SweetAlert error notification for product quantity check
                            Swal.fire({
                                title: 'Order Processing Failed',
                                text: data.message,
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    
                    });
 }



</script>



  <%- include('./layouts/footer') %>