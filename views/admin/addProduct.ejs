<%- include('./layouts/header.ejs')%>

<!-- iziToast CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.min.css">
<!-- iziToast JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css">




<% if (message.length !==0) { %>
    <script>
        // Display toast message
        iziToast.error({
            title: '<%= message %>',
            position: 'topRight',
            theme: 'dark', 
        });
    </script>
<% } %>



<section class="content-main">
    <div class="row">
        <div class="col-6">
            <div class="content-header">
                <h2 class="content-title">Add New Product</h2>
                
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-body">
                    <form action="/admin/createProduct" id="addProductForm" method="post" enctype="multipart/form-data" onsubmit="return validateForm()">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>1. General info</h6>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-4">
                                <label class="form-label">Product name</label>
                                <input type="text" id="name" placeholder="Type here" class="form-control" name="name">
                                <div class="error-message text-danger" id="name-error"></div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Description</label>
                                <textarea name="description" id="description" placeholder="Type here" class="form-control" rows="4"></textarea>
                                <div class="error-message text-danger" id="description-error"></div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Brand name</label>
                                <input name="brand" id="brand" type="text" placeholder="Type here" class="form-control">
                                <div class="error-message text-danger" id="brand-error"></div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Quantity</label>
                                <input name="quantity" id="quantity" type="number"  class="form-control">
                                <div class="error-message text-danger" id="quantity-error"></div>
                            </div>
                        </div> <!-- col.// -->
                    </div> <!-- row.// -->
                    <hr class="mb-4 mt-0">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>2. Pricing</h6>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-4">
                                <label class="form-label">Cost </label>
                                <input type="text" id="price" name="price" class="form-control">
                                <div class="error-message text-danger" id="price-error"></div>
                            </div>
                        </div> <!-- col.// -->
                    </div> <!-- row.// -->
                    <hr class="mb-4 mt-0">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>3. Date </h6>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-4">
                                <label class="form-label">Date </label>
                        
                                <input type="date" id="date" name="date" class="form-control">

                                <div class="error-message text-danger" id="date-error"></div>
                            </div>
                        </div> <!-- col.// -->
                    </div> <!-- row.// -->
                    <hr class="mb-4 mt-0">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>3. Category</h6>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-4">
                                <% category.forEach((categ, index) => { %>
                                    <label class="mb-2 form-check form-check-inline" style="width: 45%;">
                                        <input class="form-check-input" name="category" type="radio" value="<%= categ._id %>" id="category<%= index %>">
                                        <span class="form-check-label"> <%= categ.name %> </span>
                                    </label>
                                <% }) %>
                            </div>
                            <!-- Error message element placed after all category input fields -->
                            <div class="category-error text-danger" id="category-error"></div>
                        </div>
                        
                    </div> <!-- row.// -->
                    <hr class="mb-4 mt-0">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>4. Media</h6>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-4">

                                <label class="form-label">Images</label>


                                <input id="imageInput" name="images" class="form-control" type="file" multiple>

                                <div id="imagePreviewContainer"></div>

                                <input type="hidden" id="croppedImageData" name="croppedImageData">
                                
                               





          
                            </div>
                        </div> <!-- col.// -->
                    </div> <!-- .row end// -->
                    <div>
                   
                        <button type="submit" id="cropAndSubmitButton" class="btn btn-md rounded font-sm hover-up">Publish</button>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    </div>
</section> <!-- content-main end// -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>



<script>

function validateForm() {
        let isValid = true;
    
        // General Info Validation
        const name = document.getElementById('name').value.trim();
        if (!name) {
            displayErrorMessage('name-error', 'Please enter the product name.');
            isValid = false;
        } else {
            displayErrorMessage('name-error', '');
        }
    
        const description = document.getElementById('description').value.trim();
        if (!description) {
            displayErrorMessage('description-error', 'Please enter the product description.');
            isValid = false;
        } else {
            displayErrorMessage('description-error', '');
        }
    
        const brand = document.getElementById('brand').value.trim();
        if (!brand) {
            displayErrorMessage('brand-error', 'Please enter the brand name.');
            isValid = false;
        } else {
            displayErrorMessage('brand-error', '');
        }
    
        const quantity = document.getElementById('quantity').value.trim();
        if (!quantity) {
            displayErrorMessage('quantity-error', 'Please enter the product quantity.');
            isValid = false;
        } else {
            displayErrorMessage('quantity-error', '');
        }
    
        // Pricing Validation
        const price = document.getElementById('price').value.trim();
        if (!price) {
            displayErrorMessage('price-error', 'Please enter the product price.');
            isValid = false;
        } else {
            displayErrorMessage('price-error', '');
        }
    
        // Date Validation
        const date = document.getElementById('date').value.trim();
        if (!date) {
            displayErrorMessage('date-error', 'Please select a valid date.');
            isValid = false;
        } else {
            displayErrorMessage('date-error', '');
        }
    
       // Validate Category
    const selectedCategory = document.querySelector('input[name="category"]:checked');
    if (!selectedCategory) {
        const categoryError = document.getElementById('category-error');
        categoryError.textContent = 'Please select a product category.';
        isValid = false;
    } else {
        const categoryError = document.getElementById('category-error');
        categoryError.textContent = ''; // Clear error message
    }

    // Media Validation
    const images = document.getElementById('images').files;
    if (images.length === 0) {
        const imageError = document.getElementById('image-error');
        imageError.textContent = 'Please select at least one image.';
        isValid = false;
    } else {
        const imageError = document.getElementById('image-error');
        imageError.textContent = ''; // Reset error message
    }

    return isValid;
}
    
    function displayErrorMessage(elementId, message) {
        const errorElement = document.getElementById(elementId);
        errorElement.textContent = message;
    }




    //==================for the cropper.js ==========================
  
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const croppedImageDataInput = document.getElementById('croppedImageData');
    let croppieInstances = [];

    imageInput.addEventListener('change', function(event) {
        const files = event.target.files;
        for (const file of files) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                imagePreviewContainer.appendChild(img);

                const croppie = new Croppie(img, {
                    enableExif: true,
                    viewport: { width: 200, height: 200, type: 'square' },
                    boundary: { width: 300, height: 300 }
                });
                croppieInstances.push(croppie);
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('cropAndSubmitButton').addEventListener('click', function() {
        const croppedImages = [];
        for (const croppieInstance of croppieInstances) {
            croppieInstance.result('base64').then(function(result) {
                croppedImages.push(result);
                if (croppedImages.length === croppieInstances.length) {
                    croppedImageDataInput.value = JSON.stringify(croppedImages);
                    document.getElementById('addProductForm').submit();
                }
            });
        }
    });

    




    </script>
    


<%- include('./layouts/footer.ejs')%>



